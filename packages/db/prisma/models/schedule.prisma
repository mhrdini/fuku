// --------------------------------
// Reference models
// --------------------------------
model Location {
  id      String  @id @default(uuid())
  name    String
  address String?

  teamId           String            @map("team_id")
  team             Team              @relation(fields: [teamId], references: [id])
  shiftAssignments ShiftAssignment[]
  color            String            @default("#000000")

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  deletedById String?   @map("deleted_by_id")

  @@map("location")
}

model ShiftType {
  id                String              @id @default(uuid())
  name              String
  description       String?
  startTime         String              @map("start_time") // in 24-hr, zero-padded "HH:MM" format (e.g., "09:00") 
  endTime           String              @map("end_time") // same format as startTime
  shiftAssignments  ShiftAssignment[]
  color             String              @default("#000000")
  teamId            String              @map("team_id")
  team              Team                @relation(fields: [teamId], references: [id])
  eligiblePayGrades PayGradeShiftType[]

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  deletedById String?   @map("deleted_by_id")

  @@map("shift_type")
}

model OperationalHour {
  dayOfWeek Int    @map("day_of_week") // 1 = Monday, 7 = Sunday
  startTime String @map("start_time") // in 24-hr, zero-padded "HH:MM" format (e.g., "09:00") 
  endTime   String @map("end_time") // same format as startTime
  teamId    String @map("team_id")
  team      Team   @relation(fields: [teamId], references: [id])

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  deletedById String?   @map("deleted_by_id")

  @@id([teamId, dayOfWeek])
  @@index([teamId])
  @@index([dayOfWeek])
  @@map("operational_hour")
}

model PayGradeShiftType {
  payGradeId  String    @map("pay_grade_id")
  shiftTypeId String    @map("shift_type_id")
  payGrade    PayGrade  @relation(fields: [payGradeId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  shiftType   ShiftType @relation(fields: [shiftTypeId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([payGradeId, shiftTypeId])
  @@index([payGradeId])
  @@index([shiftTypeId])
  @@map("pay_grade_shift_type")
}

model StaffingRequirement {
  dayOfWeek Int    @map("day_of_week") // 1 = Monday, 7 = Sunday
  teamId    String @map("team_id")
  team      Team   @relation(fields: [teamId], references: [id])

  minMembers Int @default(1) @map("min_members")
  maxMembers Int @default(4) @map("max_members")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@id([teamId, dayOfWeek])
  @@index([teamId])
  @@index([dayOfWeek])
  @@map("staffing_requirement")
}

// --------------------------------
// Assignment models
// --------------------------------

model DayAssignment {
  id   String   @id @default(uuid())
  date DateTime

  teamMemberId String     @map("team_member_id")
  teamMember   TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  shiftAssignment ShiftAssignment? @relation("DayAssignmentToShift")
  leaveAssignment LeaveAssignment? @relation("DayAssignmentToLeave")

  @@unique([teamMemberId, date])
  @@index([date])
  @@map("day_assignment")
}

model ShiftAssignment {
  id              String        @id @default(uuid())
  locationId      String        @map("location_id")
  shiftTypeId     String        @map("shift_type_id")
  location        Location      @relation(fields: [locationId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  shiftType       ShiftType     @relation(fields: [shiftTypeId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  dayAssignmentId String        @unique @map("day_assignment_id")
  dayAssignment   DayAssignment @relation("DayAssignmentToShift", fields: [dayAssignmentId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  workHour        WorkHour?     @relation("ShiftAssignmentToWorkHour")

  @@index([locationId])
  @@index([shiftTypeId])
  @@index([locationId, shiftTypeId])
  @@map("shift_assignment")
}

model LeaveAssignment {
  id              String        @id @default(uuid())
  paid            Boolean
  dayAssignmentId String        @unique @map("day_assignment_id")
  dayAssignment   DayAssignment @relation("DayAssignmentToLeave", fields: [dayAssignmentId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("leave_assignment")
}

// --------------------------------
// Scheduling constraint models
// --------------------------------

model Unavailability {
  id           String     @id @default(uuid())
  teamMemberId String     @map("team_member_id")
  teamMember   TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  date         DateTime
  reason       String?

  @@unique([teamMemberId, date])
  @@index([teamMemberId])
  @@index([date])
  @@map("unavailability")
}

enum Metric {
  DAYS_WORKED
  HOURS_WORKED
  DAYS_OFF
  CONSECUTIVE_DAYS_WORKED
  UNIQUE_MEMBERS_ASSIGNED
}

enum TimeWindow {
  DAY
  WEEK
  MONTH
  ROLLING_WEEK
  ROLLING_MONTH
}

enum Operator {
  MIN // value >= threshold
  MAX // value <= threshold
}

model Rule {
  id             String     @id @default(uuid())
  payGradeId     String     @map("pay_grade_id")
  payGrade       PayGrade   @relation(fields: [payGradeId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  metric         Metric
  timeWindow     TimeWindow @map("time_window")
  operator       Operator
  threshold      Int
  hardConstraint Boolean    @default(false) @map("hard_constraint")

  @@index([payGradeId])
  @@map("rule")
}
